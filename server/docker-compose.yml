# Presencia - Jitsi Meet Docker Compose Stack
# Optimized for long-running 2-participant transcontinental calls.
#
# Usage:
#   cp .env.example .env
#   ./gen-passwords.sh
#   # Edit .env with your domain, email, and public IP
#   docker compose up -d

services:
  # ─── Web (Nginx + Jitsi Meet frontend) ────────────────────────
  web:
    image: jitsi/web:stable-9823
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ${CONFIG:-~/.jitsi-meet-cfg}/web:/config:Z
      - ${CONFIG:-~/.jitsi-meet-cfg}/web/crontabs:/var/spool/cron/crontabs:Z
      - ${CONFIG:-~/.jitsi-meet-cfg}/transcripts:/usr/share/jitsi-meet/transcripts:Z
      - ./custom-config/custom-config.js:/config/custom-config.js:ro
      - ./custom-config/custom-interface_config.js:/config/custom-interface_config.js:ro
    environment:
      - ENABLE_LETSENCRYPT=1
      - LETSENCRYPT_DOMAIN=${JITSI_DOMAIN}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL}
      - LETSENCRYPT_USE_STAGING=0
      - PUBLIC_URL=https://${JITSI_DOMAIN}
      - TZ=${TZ:-UTC}
      - ENABLE_XMPP_WEBSOCKET=1
    networks:
      meet.jitsi:

  # ─── Prosody (XMPP server) ───────────────────────────────────
  prosody:
    image: jitsi/prosody:stable-9823
    restart: unless-stopped
    expose:
      - "5222"
      - "5347"
      - "5280"
    volumes:
      - ${CONFIG:-~/.jitsi-meet-cfg}/prosody/config:/config:Z
      - ${CONFIG:-~/.jitsi-meet-cfg}/prosody/prosody-plugins-custom:/prosody-plugins-custom:Z
    environment:
      - AUTH_TYPE=internal
      - JICOFO_AUTH_USER=${JICOFO_AUTH_USER}
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET}
      - JVB_AUTH_USER=${JVB_AUTH_USER}
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD}
      - JIGASI_XMPP_PASSWORD=${JIGASI_XMPP_PASSWORD}
      - JIBRI_RECORDER_PASSWORD=${JIBRI_RECORDER_PASSWORD}
      - JIBRI_XMPP_PASSWORD=${JIBRI_XMPP_PASSWORD}
      - PUBLIC_URL=https://${JITSI_DOMAIN}
      - TZ=${TZ:-UTC}
    networks:
      meet.jitsi:
        aliases:
          - xmpp.meet.jitsi

  # ─── Jicofo (conference focus) ────────────────────────────────
  jicofo:
    image: jitsi/jicofo:stable-9823
    restart: unless-stopped
    depends_on:
      - prosody
    volumes:
      - ${CONFIG:-~/.jitsi-meet-cfg}/jicofo:/config:Z
    environment:
      - AUTH_TYPE=internal
      - JICOFO_AUTH_USER=${JICOFO_AUTH_USER}
      - JICOFO_AUTH_PASSWORD=${JICOFO_AUTH_PASSWORD}
      - JICOFO_COMPONENT_SECRET=${JICOFO_COMPONENT_SECRET}
      - SENTRY_DSN=0
      - TZ=${TZ:-UTC}
    networks:
      meet.jitsi:

  # ─── JVB (Jitsi Videobridge - media relay) ───────────────────
  jvb:
    image: jitsi/jvb:stable-9823
    restart: unless-stopped
    depends_on:
      - prosody
    ports:
      - "${JVB_PORT:-10000}:${JVB_PORT:-10000}/udp"
    volumes:
      - ${CONFIG:-~/.jitsi-meet-cfg}/jvb:/config:Z
    environment:
      - JVB_AUTH_USER=${JVB_AUTH_USER}
      - JVB_AUTH_PASSWORD=${JVB_AUTH_PASSWORD}
      - JVB_BREWERY_MUC=${JVB_BREWERY_MUC}
      - JVB_PORT=${JVB_PORT:-10000}
      - JVB_ADVERTISE_IPS=${JVB_ADVERTISE_IPS}
      - JVB_TCP_HARVESTER_DISABLED=${JVB_TCP_HARVESTER_DISABLED:-true}
      - JVB_STUN_SERVERS=${JVB_STUN_SERVERS}
      - SENTRY_DSN=0
      - TZ=${TZ:-UTC}
      - OTEL_EXPORTER=${OTEL_EXPORTER:-none}
    networks:
      meet.jitsi:

networks:
  meet.jitsi:
    driver: bridge
